<% let moduleId=null; for (const mod of course.modules) { if (mod.lessons.some(l=> l.id === lesson.id)) {
    moduleId = mod.id;
    break;
    }
    }
    const currentModule = course.modules.find(m => m.id === moduleId);
    const isLockedModule = currentModule?.isDemoOnly === true;
    const hasQuiz = lesson.quiz && lesson.quiz.questions && lesson.quiz.questions.length > 0;
    %>

    <section class="lesson-wrapper">
        <h3 class="lesson-title">
            <%= lesson.title %>
        </h3>

        <% if (lesson.videoUrl) { %>
            <div class="lesson-video">
                <video id="lessonVideo" src="<%= lesson.videoUrl %>" preload="metadata"></video>
                <div class="video-overlay" id="videoOverlay">
                    <img src="/icons/play-button-arrow.png" alt="Play" />
                </div>
            </div>
            <% } %>


                <% if (!hasQuiz) { %>
                    <!-- Show lesson content only if itâ€™s not a quiz -->
                    <div class="lesson-body-content">
                        <div class="lesson-content">
                            <%- lesson.content %>
                        </div>
                    </div>
                    <% } %>


                        <div class="lesson-footer">
                            <% if (!isCompleted && !isLockedModule) { %>
                                <% if (hasQuiz) { %>
                                    <div class="lesson-quiz-start-box">
                                        <p class="quiz-intro-title"><strong>This quiz consists of <%=
                                                    lesson.quiz.questions.length %> questions.</strong>
                                        </p>
                                        <p class="quiz-intro-p"><em>Get all questions correct to progress to the next
                                                module.</em></p>

                                        <form method="GET"
                                            action="/courses/<%= course._id %>/modules/<%= moduleId %>/lessons/<%= lesson.id %>/quiz?q=0">
                                            <div class="quiz-button-wrapper">
                                                <div onclick="this.closest('form').submit()" class="lesson-quiz-button">
                                                    Start Quiz</div>
                                            </div>
                                        </form>
                                    </div>
                                    <% } else { %>
                                        <form method="POST"
                                            action="/courses/<%= course._id %>/complete/<%= lesson.id %>">
                                            <div class="lesson-submit-button" onclick="this.closest('form').submit()">
                                                <%= lesson.id==="intro-1" ? "Start Course" : "Complete Lesson" %>
                                            </div>
                                        </form>
                                        <% } %>
                                            <% } else if (isCompleted && lesson.id==="intro-1" ) { %>
                                                <p class="lesson-status lesson-status-ready"><strong>You're ready to
                                                        begin Module 1!</strong></p>
                                                <% } else if (isCompleted) { %>
                                                    <p class="lesson-status lesson-status-complete"><strong>This lesson
                                                            is already marked as complete.</strong></p>
                                                    <% } %>
                        </div>
    </section>