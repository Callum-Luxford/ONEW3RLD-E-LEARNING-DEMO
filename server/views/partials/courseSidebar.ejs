<% const userProgress=user?.progress?.find(p=> p.course.toString() === course._id.toString()) || { completedLessons: []
    };
    const completed = userProgress.completedLessons || [];
    const flatLessons = course.modules.flatMap(m => m.lessons);

    // Detect quizzes by checking for a .quiz object
    const quizLessons = flatLessons.filter(l =>
    l.quiz &&
    Array.isArray(l.quiz.questions) &&
    l.quiz.questions.length > 0
    );

    const completedQuizzes = quizLessons.filter(q => completed.includes(q.id));
    %>

    <div class="sidebar" style="width: 250px; background: #f9f9f9; padding: 20px;">
        <h3>
            <%= course.title %>
        </h3>
        <p><strong>Progress:</strong> Complete <%= completedQuizzes.length %> / <%= quizLessons.length %>
        </p>

        <% course.modules.forEach((module)=> { %>
            <div class="module-block" style="margin-bottom: 20px;">
                <h4>
                    <%= module.title %>
                </h4>
                <ul style="list-style: none; padding-left: 10px;">
                    <% module.lessons.forEach((lesson)=> {
                        const flatIndex = flatLessons.findIndex(l => l.id === lesson.id);
                        const prevId = flatLessons[flatIndex - 1]?.id;
                        const isCompleted = completed.includes(lesson.id);
                        const isUnlocked =
                        lesson.id === "intro-1" ||
                        (flatIndex === 0 ? completed.includes("intro-1") : completed.includes(prevId));
                        const isCurrent = currentLesson && currentLesson.id === lesson.id;
                        %>
                        <li style="margin-bottom: 5px;">
                            <% if (isUnlocked) { %>
                                <a href="/courses/<%= course._id %>/modules/<%= module.id %>/lessons/<%= lesson.id %>"
                                    style="font-weight: <%= isCurrent ? 'bold' : 'normal' %>; color: <%= isCurrent ? '#000' : '#2a2a2a' %>;">
                                    <%= isCompleted ? 'âœ…' : 'ðŸ”“' %>
                                        <%= lesson.title %>
                                </a>
                                <% } else { %>
                                    <span style="color: #aaa;">ðŸ”’ <%= lesson.title %></span>
                                    <% } %>
                        </li>
                        <% }) %>
                </ul>
            </div>
            <% }) %>
    </div>