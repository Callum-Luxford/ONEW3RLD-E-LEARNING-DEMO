<% let moduleId=null; for (const mod of course.modules) { if (mod.lessons.some(l=> l.id === lesson.id)) {
    moduleId = mod.id;
    break;
    }
    }
    const currentModule = course.modules.find(m => m.id === moduleId);
    const isLockedModule = currentModule?.isDemoOnly === true;
    const hasQuiz = lesson.quiz && lesson.quiz.questions && lesson.quiz.questions.length > 0;
    %>

    <section class="lesson-wrapper">
        <h3 class="lesson-title">
            <%= lesson.title %>
        </h3>

        <% if (lesson.videoUrl) { %>
            <div class="lesson-video">
                <video src="<%= lesson.videoUrl %>" controls style="max-width: 100%;"></video>
            </div>
            <% } %>

                <% if (!hasQuiz) { %>
                    <!-- Show lesson content only if itâ€™s not a quiz -->
                    <div class="lesson-body-content">
                        <div class="lesson-content">
                            <%- lesson.content %>
                        </div>
                    </div>
                    <% } %>


                        <div class="lesson-footer">
                            <% if (!isCompleted && !isLockedModule) { %>
                                <% if (hasQuiz) { %>
                                    <div class="lesson-quiz-start">
                                        <p><strong>This quiz consists of <%= lesson.quiz.questions.length %>
                                                    questions.</strong></p>
                                        <p><em>Get all questions correct to progress to the next module.</em></p>
                                        <form method="GET"
                                            action="/courses/<%= course._id %>/modules/<%= moduleId %>/lessons/<%= lesson.id %>/quiz?q=0">
                                            <button type="submit" class="lesson-quiz-button">Start Quiz</button>
                                        </form>
                                    </div>
                                    <% } else { %>
                                        <form method="POST"
                                            action="/courses/<%= course._id %>/complete/<%= lesson.id %>">
                                            <div class="lesson-submit-button" onclick="this.closest('form').submit()">
                                                <%= lesson.id==="intro-1" ? "Start Course" : "Complete Lesson" %>
                                            </div>
                                        </form>
                                        <% } %>
                                            <% } else if (isCompleted && lesson.id==="intro-1" ) { %>
                                                <p class="lesson-status lesson-status-ready"><strong>You're ready to
                                                        begin Module 1!</strong></p>
                                                <% } else if (isCompleted) { %>
                                                    <p class="lesson-status lesson-status-complete"><strong>This lesson
                                                            is already marked as complete.</strong></p>
                                                    <% } %>
                        </div>
    </section>